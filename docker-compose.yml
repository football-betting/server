version: '3'

services:

    rabbitmq:
        image: rabbitmq:3.8-management
        environment:
            RABBITMQ_DEFAULT_USER: admin
            RABBITMQ_DEFAULT_PASS: admin
        volumes:
            - rabbitmq-data:/var/lib/rabbitmq
        networks:
            - private

    loadbalancer:
        image: nginx:1.17.8-alpine
        volumes:
            - ./docker/nginx/loadbalancer.conf:/etc/nginx/conf.d/default.conf
        networks:
            - private
        depends_on:
            - api-web
            - tip-web
            - frontend-web
            - match-api-web
            - match-web
            - calculation-list-web
            - ranking-list-web

    php-fpm:
        build:
            context: docker/php
            args:
                PUID: ${PUID}
        volumes:
            - ./.composer/:/.composer
            - ./em2021-api/:/data-api/
            - ./tips/:/data-tips/
            - ./match/:/data-match/
            - ./match-api/:/data-match-api/
            - ./frontend/:/data-frontend/
            - ./calculation-list/:/data-calculation-list/
            - ./ranking-list/:/data-ranking-list/
        networks:
            - default
            - private
            - api
            - tip
            - match
        environment:
            - APP_ENV=docker
        depends_on:
            - rabbitmq

    api-db:
        image: mysql:5.7
        environment:
            MYSQL_ROOT_PASSWORD: admin
        volumes:
            - mysql-data:/var/lib/mysql
        networks:
            - api

    api-redis:
        image: redis:6
        command: redis-server --appendonly yes
        volumes:
            - redis-data-api:/data
        networks:
            - api

    api-web:
        image: nginx:1.17.8-alpine
        volumes:
            - ./em2021-api/:/data-api/
            - ./docker/nginx/vhost-api.conf:/etc/nginx/conf.d/default.conf
        networks:
            api:
            private:
                aliases:
                    - web.api
        depends_on:
            - api-db
            - api-redis
            - php-fpm

    tip-redis:
        image: redis:6
        command: redis-server --appendonly yes
        volumes:
            - redis-data-tip:/data
        networks:
            - tip

    tip-web:
        image: nginx:1.17.8-alpine
        volumes:
            - ./tips/:/data-tips/
            - ./docker/nginx/vhost-tips.conf:/etc/nginx/conf.d/default.conf
        networks:
            tip:
            private:
                aliases:
                    - web.tip
        depends_on:
            - tip-redis
            - php-fpm

    match-redis:
        image: redis:6
        command: redis-server --appendonly yes
        volumes:
            - redis-data-match:/data
        networks:
            - match

    match-web:
        image: nginx:1.17.8-alpine
        volumes:
            - ./match/:/data-match/
            - ./docker/nginx/vhost-match.conf:/etc/nginx/conf.d/default.conf
        networks:
            match:
            private:
                aliases:
                    - web.match
        depends_on:
            - match-redis
            - php-fpm

    match-api-web:
        image: nginx:1.17.8-alpine
        volumes:
            - ./match-api/:/data-match-api/
            - ./docker/nginx/vhost-match-api.conf:/etc/nginx/conf.d/default.conf
        networks:
            private:
                aliases:
                    - web.match-api
        depends_on:
            - php-fpm

    frontend-web:
        image: nginx:1.17.8-alpine
        volumes:
            - ./frontend/:/data-frontend/
            - ./docker/nginx/vhost-frontend.conf:/etc/nginx/conf.d/default.conf
        networks:
            private:
                aliases:
                    - web.frontend
        depends_on:
            - php-fpm

    ranking-list-redis:
        image: redis:6
        command: redis-server --appendonly yes
        volumes:
            - redis-data-ranking-list:/data
        networks:
            - ranking-list

    ranking-list-web:
        image: nginx:1.17.8-alpine
        volumes:
            - ./ranking-list/:/data-ranking-list/
            - ./docker/nginx/vhost-ranking-list.conf:/etc/nginx/conf.d/default.conf
        networks:
            ranking-list:
            private:
                aliases:
                    - web.ranking-list
        depends_on:
            - ranking-list-redis
            - php-fpm

    calculation-list-redis:
        image: redis:6
        command: redis-server --appendonly yes
        volumes:
            - redis-data-calculation-list:/data
        networks:
            - calculation-list

    calculation-list-web:
        image: nginx:1.17.8-alpine
        volumes:
            - ./calculation-list/:/data-calculation-list/
            - ./docker/nginx/vhost-calculation-list.conf:/etc/nginx/conf.d/default.conf
        networks:
            calculation-list:
            private:
                aliases:
                    - web.calculation-list
        depends_on:
            - calculation-list-redis
            - php-fpm

volumes:
    rabbitmq-data:
    mysql-data:
    redis-data-api:
    redis-data-tip:
    redis-data-match:
    redis-data-ranking-list:
    redis-data-calculation-list:

networks:
    api:
    tip:
    match:
    ranking-list:
    calculation-list:
    private:
